### [Flask留言板](https://114514.pythonanywhere.com/#)

>  再次重写留言板，该版将会代替旧版。
>
> 开始日期：2020年3月19日
>
> 结束日期：暂定

#### 新版新增特性

- [x] ~~用户认证（关于用户发帖修改功能这方面认证暂且没有明确思路）~~
- [x] ~~一对多的用户留言数据表~~ 
  * 还是改为匿名发送了
- [X] 使用flex布局
- [x] 留言置顶 
- [x] 日志页
- [x] 隐藏留言卡片
- [x] 回复留言
- [x] 删除留言
- [ ] 编辑留言 感觉挺麻烦的所以鸽了

#### 匿名用户权限

* 回复留言
* 发布留言

#### 管理员附加权限

* 删除留言
* 置顶留言
* 设置留言是否登录可见
* ~~留言可以使用HTML标签~~ 不想多加判断了（懒）

#### 需要用到的轮子

- flask_sqlalchemy 数据库相关
- flask_login 用户认证相关
- flask_migrate 数据库迁移工具（这个服务端目前用不上，而且PythonAnywhere上没有这个包，所以部署的时候要记得给注释掉）
- flask_wtf 表单相关
- wtforms 同上

#### 2021年12月25日 诈尸更新

> 实际并算不上更新

发现初始化数据库忘了，现记录下正确步骤：

1. 创建 flask shell
2. 用暴露出来的 db 对象，执行 `db.create_all()`

#### 2020年4月21日深夜 进度

> 一如既往的没有目标的日子。

好久不见，今天留言时觉得功能还不够完善所以又新增了一条用户权限。

flask 感觉生疏了不少，好在基本的操作大概还记得再拿上以前的代码，功能总算是完成了。

**把本地测试用的数据库文件传到服务器上了，幸好在替换前有备份，加上 flask migrate 也比较给力，除了浪费了一点时间之外没有任何损失。**

**备份给我备三回啊！三回！**

#### 2020年3月22日 进度

今天对布局和样式进行了微调，初步适配移动端。

* 提升了隐藏动画的效果，原版wrap没有最小高度导致隐藏留言块后添加显示元素块会把wrap撑开，后果是会造成界面抖动

* 新增回复框显示动画
* 修复了之前可以回复空文本的Bug（还好后端还会再判断一遍）
* 新增前端发送留言合法性判断逻辑

#### 2020年3月21日 进度

* 初步实现回复功能（使用的是一对多关系，缺陷是显示回复楼层会错乱）
* 初步实现回复布局 
* 实现置顶功能
* 实现删除留言功能

**踩的坑**

1. 在添加留言功能后导致日志页出错，因为日志页不提供回复功能，而调用了不存在显示留言方法。解决方法是在首页路由和日志路由中分别传入一个是否能够留言的flag，利用短路解决问题。

2. 用ajax实现了留言回复，在服务端要通过`request.form.get('参数名')`获取ajax传递的参数，先前还以为是用`request.args.get('参数名')`获取，但事实上后者是用来获取URL参数的。另外在发送post请求时由于jQuery本身的原因（？）会导致重复发送请求，解决方如下:

   ```javascript
   $('dom').unbind('click').click(function(){
       $.post(...);
   });
   ```

   从字面上看就是先解绑一遍`click`事件再重新绑定一次，至于为何有效暂且不知道。

3. Ajax发送完成后需要刷新页面，使用一次`window.location.reload()`没有效果，要用两次，可能是由于浏览器缓存的原因。本来显示回复这个功能是可以用JS动态添加到DOM里的，但是不知道为什么代码无法实现，所以还是先用刷新来替代了。

**一些闲话**

剩下的部分功能大概都要用到JS了，操作DOM不说调用Ajax估计也忘得差不多了，感觉很麻烦的样子。

除了编辑功能其他功能都差不多完成了，解决问题时多次面向搜索引擎编程...不过问题解决了，可喜可贺（）。

#### 2020年3月20日 进度

* 完成发送留言页布局
* 发送页面实现置顶功能
* 完成日志页（逻辑基本和显示留言一样）
* 实现登录功能

自此基本功能基本都已经实现了，剩下的管理员删除留言，隐藏留言块等功能需要用到JS，这部分也不难，先放着，随缘实现（屑颜）。布局上还要加个fixed回到顶部，虽然大部分都完成但是这些小细节却没得到注意...

**踩的坑**

1. 使用*.flaskenv*设置shell上下文时，`FLASK_APP`的值不能和包名相同，也就是说如果有个`app.py`作为启动文件，那么组件包名就不能为app，反之亦然。
2. 给标题字段设置了一个默认值，但是flask-form文本字段返回的空值为空文本，而不是None，所以还是得在代码里判断用户是否输入标题。

**数据库迁移也忘了，在这里记录一下正确步骤**

1. flask db init 仅在初始化时调用
2. flask db migrate
3. flask db upgrade/downgrade 升级/回滚

**一些闲话**

代码仍是先实现布局再实现逻辑，删删改改一下午就过去了。不得不说调试真的不方便，无奈电脑带PyCharm太卡，Geany虽然相比没那么方便但也够用。

置顶留言功能加个flag然后在查询的时候排个序就行，之前还单独搞一个表存（而且功能也没实现），想法太天真了w。

表单这部分感觉手熟些了。除了用`wtf.quick_form`，关于用`wtf`生成的元素的样式定义目前看到的教程貌似都没有提到，之前用的时候Bootstrap类名和自己定义的有冲突，怕这次也会出现类似的问题，所以这条放弃。其实在类中定义元素时的变量名是作为元素id自动添加的，所以可以利用CSS设置元素样式，但是把id硬编码到CSS也不是个太好的方法（如果修改元素变量名，可能会导致原先样式失效），不过够用。

#### 2020年3月19日 进度

* 主页面布局基本搞定（先写的布局，还没开始写逻辑，感觉有点本末倒置w，不过一开始太简陋也看不下去，接下来就专注逻辑了）。

**待完成**

* 用户注册\登录页面
* 发送留言页面
* 日志页面
